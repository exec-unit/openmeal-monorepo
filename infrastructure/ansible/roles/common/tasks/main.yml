---
# ============================================================================
# Common Role - Main Tasks
# ============================================================================
# Prepares a clean Debian 12 system with base configuration
# ============================================================================

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  retries: 3
  delay: 5
  register: common_apt_update
  until: common_apt_update is success

- name: Upgrade all packages to latest version
  ansible.builtin.apt:
    upgrade: dist
    autoremove: yes
    autoclean: yes
  retries: 3
  delay: 5
  register: common_apt_upgrade
  until: common_apt_upgrade is success

- name: Install base packages
  ansible.builtin.apt:
    name: "{{ common_base_packages }}"
    state: present
  retries: 3
  delay: 5
  register: common_apt_install
  until: common_apt_install is success

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: inventory_hostname is defined

- name: Set timezone
  community.general.timezone:
    name: "{{ common_timezone }}"
  when: common_timezone is defined

- name: Create application group
  ansible.builtin.group:
    name: "{{ common_app_group }}"
    state: present

- name: Create application user
  ansible.builtin.user:
    name: "{{ common_app_user }}"
    group: "{{ common_app_group }}"
    home: "{{ common_app_home }}"
    shell: /bin/bash
    create_home: yes
    state: present

- name: Create application directory
  ansible.builtin.file:
    path: "{{ common_app_home }}"
    state: directory
    owner: "{{ common_app_user }}"
    group: "{{ common_app_group }}"
    mode: '0755'

- name: Check if swap file exists
  ansible.builtin.stat:
    path: /swapfile
  register: common_swap_file_check
  when: common_enable_swap

- name: Create swap file
  ansible.builtin.command:
    cmd: "fallocate -l {{ common_swap_size_mb }}M /swapfile"
    creates: /swapfile
  when:
    - common_enable_swap
    - not common_swap_file_check.stat.exists
  register: common_swap_created

- name: Set swap file permissions
  ansible.builtin.file:
    path: /swapfile
    mode: '0600'
  when:
    - common_enable_swap
    - common_swap_file_check.stat.exists or common_swap_created is changed

- name: Format swap file
  ansible.builtin.command:
    cmd: mkswap /swapfile
  when:
    - common_enable_swap
    - common_swap_created is changed
  changed_when: true

- name: Check if swap is already enabled
  ansible.builtin.command: swapon --show
  register: common_swap_status
  changed_when: false
  failed_when: false
  when: common_enable_swap

- name: Enable swap file
  ansible.builtin.command: swapon /swapfile
  when:
    - common_enable_swap
    - common_swap_created is changed
    - "'/swapfile' not in common_swap_status.stdout"
  changed_when: true

- name: Add swap to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    line: '/swapfile none swap sw 0 0'
    state: present
  when: common_enable_swap

- name: Set swappiness
  ansible.posix.sysctl:
    name: vm.swappiness
    value: '10'
    state: present
  when: common_enable_swap

- name: Display system information
  ansible.builtin.debug:
    msg:
      - "System prepared successfully"
      - "App user: {{ common_app_user }}"
      - "App home: {{ common_app_home }}"
      - "Swap enabled: {{ common_enable_swap }}"
