---
# ============================================================================
# Sync Files Task
# ============================================================================
# Synchronizes project files from Ansible controller to target server
# Uses centralized configuration from defaults/main.yml
# ============================================================================

- name: Ensure required directories exist
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: "{{ item.mode }}"
  loop: "{{ ensure_directories }}"
  loop_control:
    label: "{{ item.path }}"

- name: Synchronize directories to target server
  ansible.posix.synchronize:
    src: "{{ project_root }}/{{ item.src }}/"
    dest: "{{ app_home }}/{{ item.dest }}/"
    delete: "{{ item.delete | default(false) }}"
    rsync_opts: "{{ item.rsync_opts | default([]) }}"
    # Force use of Ansible's SSH connection settings
    dest_port: "{{ ansible_port | default(22) }}"
    private_key: "{{ ansible_ssh_private_key_file | default(omit) }}"
    # Use sudo on remote side for permissions
    rsync_path: "sudo rsync"
    # Override the remote user to match Ansible connection
    set_remote_user: true
  vars:
    ansible_ssh_user: "{{ ansible_user }}"
  become: no
  delegate_to: localhost
  loop: "{{ sync_directories }}"
  loop_control:
    label: "{{ item.name }}"
  register: sync_dirs_result

- name: Set ownership for synchronized directories
  ansible.builtin.file:
    path: "{{ app_home }}/{{ item.dest }}"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    recurse: yes
  loop: "{{ sync_directories }}"
  loop_control:
    label: "{{ item.name }}"

- name: Copy individual files to target server
  ansible.builtin.copy:
    src: "{{ project_root }}/{{ item.src }}"
    dest: "{{ app_home }}/{{ item.dest }}"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: "{{ item.mode }}"
  loop: "{{ sync_files }}"
  loop_control:
    label: "{{ item.name }}"

- name: Make shell scripts executable
  ansible.builtin.shell: |
    find {{ app_home }}/scripts -type f -name "*.sh" -exec chmod +x {} \;
  changed_when: false

- name: Display synchronization summary
  ansible.builtin.debug:
    msg:
      - "âœ“ Project files synchronized to {{ app_home }}"
      - "Directories synced: {{ sync_directories | map(attribute='name') | join(', ') }}"
      - "Files copied: {{ sync_files | map(attribute='name') | join(', ') }}"
