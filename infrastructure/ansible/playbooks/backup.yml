---
# ============================================================================
# OpenMeal - Manual Backup Playbook
# ============================================================================
# Triggers manual backup of databases using backup role
#
# Usage:
#   ansible-playbook -i inventories/stage/hosts.yml playbooks/backup.yml
#
# ============================================================================

- name: Create OpenMeal Backups
  hosts: all
  become: yes

  vars_files:
    - "{{ inventory_dir }}/group_vars/all.yml"
    - "{{ inventory_dir }}/group_vars/vault.yml"

  pre_tasks:
    - name: Display backup information
      ansible.builtin.debug:
        msg:
          - "OpenMeal Manual Backup"
          - "Environment: {{ deployment_type }}"

  roles:
    - role: backup
      when: backup_enabled | default(false)

  tasks:
    - name: Manual PostgreSQL backup
      ansible.builtin.command:
        cmd: "{{ app_home }}/.restic/backup-postgres.sh"
      become_user: "{{ app_user }}"
      register: postgres_backup
      changed_when: true
      when: backup_enabled | default(false)

    - name: Display PostgreSQL backup result
      ansible.builtin.debug:
        msg: "{{ postgres_backup.stdout_lines }}"
      when: backup_enabled | default(false)

    - name: Manual MongoDB backup
      ansible.builtin.command:
        cmd: "{{ app_home }}/.restic/backup-mongo.sh"
      become_user: "{{ app_user }}"
      register: mongo_backup
      changed_when: true
      when: backup_enabled | default(false)

    - name: Display MongoDB backup result
      ansible.builtin.debug:
        msg: "{{ mongo_backup.stdout_lines }}"
      when: backup_enabled | default(false)

    - name: List recent snapshots
      ansible.builtin.command:
        cmd: restic snapshots --last
      environment:
        RESTIC_REPOSITORY: "{{ backup_restic_repository }}"
        RESTIC_PASSWORD: "{{ vault_restic_password }}"
        AWS_ACCESS_KEY_ID: "{{ vault_s3_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ vault_s3_secret_access_key }}"
        AWS_DEFAULT_REGION: "{{ backup_s3_region }}"
      become_user: "{{ app_user }}"
      register: restic_snapshots
      changed_when: false
      when: backup_enabled | default(false)

    - name: Display backup summary
      ansible.builtin.debug:
        msg:
          - "✓ Backups Created!"
          - "Repository: {{ backup_restic_repository }}"
          - "Recent snapshots:"
          - "{{ restic_snapshots.stdout_lines }}"
      when: backup_enabled | default(false)

    - name: Display backup disabled message
      ansible.builtin.debug:
        msg:
          - "⚠ Backups are disabled"
          - "Set backup_enabled: true in group_vars to enable"
      when: not (backup_enabled | default(false))
